---
title: "Gene and metabolite correlation"
output: html_notebook
---

# Loading datasets

```{r}
library(tidyr)
```

## Gene dataset

```{r}
gene_df = read.csv(file="../raw_data/Quantifications_and_functional_annotations.tsv",
              sep="\t",
              stringsAsFactors = TRUE,
              #nrow = 1000,
              na.strings = c("NA", "-"))
```

After loading the gene dataset, we remove all columns except those containing the number of reads and the columns called "Prefered name" which seems to contain names for matched genes.

```{r}
dim_raw = dim(gene_df)[1]
gene_df = gene_df[,c(2:35,44)]
gene_df = drop_na(gene_df)
print(paste0((dim(gene_df)[1]/dim_raw)*100, "% of the rows have been conserved (",dim(gene_df)[1],")"))

head(gene_df)
colnames(gene_df) = c(paste0("Piglet_", seq(34)), "Gene")
gene_df = gene_df[c(dim(gene_df)[2], 1:(dim(gene_df)[2])-1)] #pour mettre la colonne gène à gauche.
```

The relative abundances are then computed.

```{r}
for (i in 2:35){
  sum_col = sum(gene_df[,i])
  if (sum_col != 0){
    gene_df[,i] = gene_df[,i]/sum_col
  }
}
```

We then aggregate the duplicated genes by row.

```{r}
gene_df = aggregate(gene_df[-1], by = list(gene_df$Gene), FUN = sum)
colnames(gene_df)[1] = "Gene"

gene_names = levels(gene_df$Gene) ## Saving the list of genes names for later
head(gene_df)
```

Finally, the data.frame is translated.

```{r}
gene_df = as.data.frame(t(gene_df)) #on transpose df (indiv en ligne et genes en colonne)
colnames(gene_df) = gene_df[1,]
gene_df = gene_df[-1,]
gene_df$Piglet = rownames(gene_df)

head(gene_df)
```

## Metabolite dataset

```{r}
metabo_df = read.csv(file="../raw_data/HOLOPIG METABOLITES clean.csv",
                    sep=";",
                    stringsAsFactors = TRUE,
                    na.strings = "NA",
                    check.names = F)
metabo_df = subset(metabo_df, select = -c(Group)) ## Removing "Group" column

metabo_df$Piglet = paste0("Piglet_",as.character(metabo_df$Piglet)) ## Renaming piglets
metabo_names = colnames(metabo_df[-1]) ## Saving the name of metabolites for later

head(metabo_df)
```

## Merging both dataframe

```{r}
data = merge(gene_df, metabo_df, by = "Piglet", all = T) ## Merging dataframes by the name of the piglet.

data[,-1] = as.numeric(unlist(data[,-1])) ## Converting characters to numeric
data = Filter(function(x)!all(is.na(x)), data) ## Removing empty columns

head(data)
```

# Correlating *data* data.frame

```{r}
cor_data = as.data.frame( cor(data[,-1], method = "spearman") )
head(cor_data)
```

```{r}
cor_data$metabolites <- rownames(cor_data)
cor_data = cor_data[c(dim(cor_data)[2], 1:(dim(cor_data)[2])-1)]
head(cor_data)
```

```{r}
library(reshape2)

melted_data = melt(cor_data, id = "metabolites") ## Melting the data.frame
melted_data = drop_na(melted_data) ## Removing empty columns
melted_data$metabolites = as.factor(melted_data$metabolites) 
colnames(melted_data)[2] = "genes"

## Removing genes in metabolite column and reverse.
melted_data = subset(melted_data, metabolites %in% metabo_names & genes %in% gene_names)
melted_data = droplevels.data.frame(melted_data)

head(melted_data)
```

We then export the current dataframe.

```{r}
write.table(melted_data, 
            file = "../refined_data/metabo_X_gene_cor.tsv",
            col.names = TRUE,
            row.names = FALSE,
            sep="\t")
```

# Filtering metabolites and genes according to their correlation mean.

In order to do that, we aggregate the correlation values according to the metabolite first and then the gene. That way we compute means for correlation according a given metabolite across genes and then a given gene across metabolites.

```{r}
metabo_means = aggregate(melted_data$value, by = list(melted_data$metabolites),
                          FUN = mean)
colnames(metabo_means) = c("metabolite", "mean")
metabo_means$mean = abs(metabo_means$mean)

gene_means = aggregate(melted_data$value, by = list(melted_data$genes),
                        FUN = mean)
colnames(gene_means) = c("gene", "mean")
gene_means$mean = abs(gene_means$mean)

head(gene_means)
```

We then subset *melted_data* using thresholds on both genes and metabolites. For that we will plot the distribution of correlation means.

```{r}
library(ggplot2)

proportion = 0.05

proportion = 1-proportion

## Getting the quantile as threshold
thres_genes = quantile(gene_means$mean, prob=c(proportion), type=1)
thres_metabo = quantile(metabo_means$mean, prob=c(proportion), type=1)
```

We plot the threshold on histograms to see where it lands

```{r}
ggplot(gene_means, aes(x=mean)) + 
  geom_histogram(binwidth=0.01) +
  geom_vline(xintercept = thres_genes, linetype = "dashed", linewidth = 1.5, 
             color = "red")+
  geom_label(label = paste0("Threshold\n",round(thres_genes, 3)), 
             x = thres_genes, y = 4, 
             color = "red")+
  xlab("Correlation mean")+
  ggtitle("Distribution of correlation means across genes")
```

```{r}
ggplot(metabo_means, aes(x=mean)) + 
  geom_histogram(binwidth=0.01) +
  geom_vline(xintercept = thres_metabo, linetype = "dashed", linewidth = 1.5, 
             color = "red")+
  geom_label(label = paste0("Threshold\n",round(thres_metabo, 3)), 
             x = thres_metabo, y = 4, 
             color = "red")+
  xlab("Correlation mean")+
  ggtitle("Distribution of correlation means across metabolites")
```

Applying the filter on the data.frame.

```{r}
selected_genes = subset(gene_means, mean >= thres_genes)$gene
selected_metabo = subset(metabo_means, mean >= thres_metabo)$metabolite

filtered_melted_data = subset(melted_data, 
                              metabolites %in% selected_metabo | genes %in% selected_genes)

head(filtered_melted_data)
```

We save the filtered dataframe.

```{r}
write.table(filtered_melted_data, 
            file = "../refined_data/filtered_metabo_X_gene_cor.tsv",
            col.names = TRUE,
            row.names = FALSE,
            sep="\t")
```

# Creating the heatmap

```{r}
ggplot(filtered_melted_data, aes(genes, metabolites, fill= value)) +
  geom_tile(colour = "white", size = 0.5)+
  scale_fill_gradientn(name = "Correlation coefficient",# definition of the color gradient.
                       #trans = "log10", #chosing a logarythmic color scale
                       breaks = c(-1, -0.5, 0, 0.5 ,1), 
                       labels = c(-1, -0.5, 0, 0.5 ,1),
                       #na.value = "#43A3B9",# plotting the 0 in the lowest color of the gradient
                       colours = c("#43A3B9",  "#D0EC97", "#FFFFDF", "#FD945D", "#DC4E51", "#370303"),
  )+
  
  scale_x_discrete(expand=c(0, 0))+ # Removing blank space between data and X axis
  labs(fill="correlation coefficient", # Setting legend and title name
       title = "Correlation coefficients between genes and metabolites")+
  theme_grey(base_size=12)+ # Setting the base font size
  theme(line = element_blank(), # Removing the lines in between the boxes
        axis.ticks.x = element_blank(), # Removing ticks on X axis
        axis.text.x = element_text(angle = 90, face="bold.italic", size = 30), # Removing X labels
        axis.text.y = element_text(face="bold.italic", size = 30), # Setting Y labels to bold
        axis.title.x = element_blank(), # Removing X axis title
        axis.title.y = element_blank(), # Removing Y axis title
        panel.border=element_blank(), # Removing space between figure and panel
        legend.text=element_text(face="bold", size = 15), # Customizing legend font
        plot.title = element_text(face="bold", size = 50), # Same with main title
        legend.title = element_text(face="bold", size = 15), # Same with legend
        legend.key.size = unit(2, "cm"), # Setting the legend scale
        strip.text.y = element_text(angle = 0, face = "bold", size = 15),
        strip.text.x = element_text( face = "bold", size = 15))
        
  #facet_grid(rows = vars(filtered_data$kingdom), 
             #cols = vars(factor(filtered_data$cat, 
                                #levels = c("Control", "Colistin"))),
             #scales = "free",
             #space = "free")

#SAVE HEATMAP  
scale = 200 # Set the scale for the exported image

ggsave(filename = "../export/heatmap_correlation_VA.png",
       plot = last_plot(),
       width = 40*scale,
       height = 30*scale,
       units = "px",
       dpi=200)
```
