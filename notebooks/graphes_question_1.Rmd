---
title: "Visualisation of taxonomic datas"
output: html_notebook
---
## I. Barplot of reigns 
### 1) Creation of a data frame with the relative abundance of each reign
The csv file treated to seperate the taxonomic informations is red. 
A loop is created to merge all the line of the same reign and sum their relative abundances.

```{r}
#reading the csv file
df = read.csv(file="../refined_data/taxonomic_abondance.csv",
              sep=";")

#creation of a new column in df with the mean relative abundance of each lign
moyenne = data.frame(mean = mean(c(t(df[1,-(1:7)]))))
for (var in c(2:dim.data.frame(df)[1])){
  moyenne = rbind (moyenne, mean(c(t(df[var,-(1:7)]))))
}
df = cbind(df, moyenne)

#initialisation of dat_regne and the counter test.
dat_regne= data.frame("NA" = 0)
test=0

for (var in c(1:dim.data.frame(df)[1])){
#if there is no reign information, the lign is ignore to avoid errors.
  if (is.na(df[var,]$regne)){
    dat_regne[2,1]=as.integer(dat_regne[2,1]) + df[var,]$mean
    test=0
    next
  }
#loop on the columns of dat_regne to check if it has been already encountered in the data frame.
  for (var2 in c(1:dim.data.frame(dat_regne)[2])){
# if the reign already exists in dat_regne, the relative abundance is added.
    if (df[var,]$regne == dat_regne[1,var2]){
      dat_regne[2,var2]=as.integer(dat_regne[2,var2]) + df[var,]$mean  
      test=0
      break
    }
    else {test=1}
  } 
#if the reign is new, a new column is added with the reign and the relative abundace of the lign.
  if (test==1){
    dat_regne= cbind(dat_regne, c(df[var,]$regne , df[var,]$mean))
    colnames(dat_regne[var2])= df[var,]$regne
    test = 0
  }
}

```


### 2) Barplot

```{r}
# Load ggplot2
  library(ggplot2)

#new data frame with transposed reigns and abundances
data <- data.frame(
  regne=c(t(dat_regne[1,])) ,  
  value=c(t(dat_regne[2,]))
)

# Barplot
ggplot(data, aes(x=regne, y=value)) + 
  geom_bar(stat = "identity") +
  coord_flip()
```


## II. Heatmap of abundances by genre

### 1) refining the data

the data are refined to merge the same values of taxonomy and separate the groups (control and treated with colistine).

```{r}
# Refining abundance data : abundance by genre and sample.
rm(list=ls())

df = read.csv(file="../refined_data/taxonomic_abondance.csv",
              sep=";",
              stringsAsFactors = TRUE,
              na.strings = "NA")

# Suppression des Règnes non identifiés
df = droplevels(subset(df, regne %in% c("Bacteria", "Archaea", "Eukaryota", "Viruses")))

genre = unique(df[["genre"]])
genre = genre[-1]

df_bygenre = data.frame(genre, row.names=genre)
for (name in genre){
  for (col in colnames(df)[8:41]){
    tmp = sum(subset(df, genre == name)[[col]])
    # print(tmp)
    df_bygenre[name,col] = tmp
  }
}



df_bp = expand.grid(genre=genre, ind=as.character(seq(1:34)))
values = c()
for (col in colnames(df_bygenre)[2:35]){
  values = c(values, df_bygenre[[col]])
}
df_bp$values = values

bacteries = levels( droplevels( subset(df, regne == "Bacteria")$genre ) )
archees = levels( droplevels( subset(df, regne == "Archaea")$genre ) )
euka = levels( droplevels( subset(df, regne == "Eukaryota")$genre ) )
virus = levels( droplevels( subset(df, regne == "Viruses")$genre ) )
categorie = c("Control", "Colistine", "Control", "Control", "Control", "Control",
              "Colistine", "Colistine", "Control", "Colistine", "Colistine", "Control",
              "Control", "Control", "Control", "Control", "Control", "Colistine",
              "Colistine", "Colistine", "Colistine", "Colistine", "Control", "Control",
              "Control", "Control", "Control", "Colistine", "Control", "Colistine",
              "Colistine", "Colistine", "Colistine", "Colistine")

for (row in 1:dim(df_bp)[1]){
  if (df_bp[row, "genre"] %in% bacteries){df_bp[row, "regne"] = "Bacteria"}
  if (df_bp[row, "genre"] %in% archees){df_bp[row, "regne"] = "Archaea"}
  if (df_bp[row, "genre"] %in% euka){df_bp[row, "regne"] = "Eukaryota"}
  if (df_bp[row, "genre"] %in% virus){df_bp[row, "regne"] = "Viruses"}
  df_bp[row, "type"] = categorie[as.double(df_bp[row, "ind"])]
}

df_bp$type = as.factor(df_bp$type)
df_bp$regne = as.factor(df_bp$regne)
df_bp = df_bp[, c(4, 5, 1, 2, 3)]

write.table(df_bp, 
            file = "../refined_data/taxonomic_abondance_by_genre.csv",
            col.names = TRUE,
            row.names = FALSE,
            sep=";")

```



```{r}

library(ggplot2)
library(RColorBrewer)
#library(scales)
thres = 0.001

# Filtering data and getting the log of the values.
data = subset(df_bp, values >= thres)
data$values = log(data$values)

ggplot(data, aes(ind, genre, fill= values)) + 
  geom_tile(colour = "white", size = 0.5)+
  scale_fill_distiller(palette = "Spectral", 
                       limits = c(min(data$values), max(data$values)),
                       direction = -1) +
  scale_y_discrete(expand=c(0, 0))+
  scale_x_discrete(expand=c(0, 0))+
  labs(fill="Logarithme de\nl'abondance relative", title = "Abondance relative des genres par échantillon")+
  theme_grey(base_size=12)+
  theme(line = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(face="bold.italic"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border=element_blank(),
        legend.text=element_text(face="bold", size = 15),
        plot.title = element_text(face="bold", size = 25),
        legend.title = element_text(face="bold", size = 15),
        legend.key.size = unit(2, "cm"),
        strip.text.y = element_text(angle = 0, face = "bold", size = 15),
        strip.text.x = element_text(face = "bold", size = 15))+
  facet_grid(rows = vars(data$regne), 
             cols = vars(factor(data$type, levels = c("Control", "Colistine"))),
             scales = "free",
             space = "free",
             labeller = )
scale = 200
ggsave(filename = "../export/HM_taxo_complete.png",
       width = 16*scale,
       height = 18*scale,
       units = "px",
       dpi=200)
```






















